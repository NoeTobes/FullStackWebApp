// Global variables
let currentUser = null;
const STORAGE_KEY = 'ipt_demo_v1';

// Database structure
window.db = {
    accounts: [],
    departments: [],
    employees: [],
    requests: []
};

// Route configuration
const routes = {
    '/': 'home-page',
    '/register': 'register-page',
    '/verify-email': 'verify-email-page',
    '/login': 'login-page',
    '/profile': 'profile-page',
    '/employees': 'employees-page',
    '/departments': 'departments-page',
    '/accounts': 'accounts-page',
    '/requests': 'requests-page'
};

// Protected routes (require authentication)
const protectedRoutes = ['/profile', '/requests'];

// Admin routes (require admin role)
const adminRoutes = ['/employees', '/departments', '/accounts'];

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    console.log('App initialized');
    
    // Set initial hash if empty
    if (!window.location.hash || window.location.hash === '#') {
        window.location.hash = '#/';
    }
    
    // Load data from localStorage
    loadFromStorage();
    
    // Add hash change listener
    window.addEventListener('hashchange', handleRouting);
    
    // Initial routing
    handleRouting();
    
    // Setup form listeners
    setupFormListeners();
    
    // Setup navigation links
    setupNavigationLinks();
    
    // Check for existing session
    checkExistingSession();
    
    // Log storage status
    logStorageStatus();
});

// Load data from localStorage
function loadFromStorage() {
    try {
        const stored = localStorage.getItem(STORAGE_KEY);
        
        if (stored) {
            const parsedData = JSON.parse(stored);
            
            // Validate the structure of loaded data
            if (isValidDbStructure(parsedData)) {
                window.db = parsedData;
                console.log('âœ… Data loaded successfully from storage');
                showNotification('Data loaded from storage', 'info', 2000);
            } else {
                console.error('âŒ Invalid data structure in storage, reseeding...');
                seedDefaultData();
            }
        } else {
            console.log('â„¹ï¸ No existing data found, seeding with defaults');
            seedDefaultData();
        }
    } catch (e) {
        console.error('âŒ Failed to parse stored data:', e);
        showNotification('Storage corruption detected. Resetting data...', 'warning');
        seedDefaultData();
    }
}

// Validate database structure
function isValidDbStructure(data) {
    // Check if data has all required collections
    const requiredCollections = ['accounts', 'departments', 'employees', 'requests'];
    
    for (const collection of requiredCollections) {
        if (!Array.isArray(data[collection])) {
            console.error(`Missing or invalid collection: ${collection}`);
            return false;
        }
    }
    
    // Validate accounts structure (optional but good practice)
    if (data.accounts.length > 0) {
        const sampleAccount = data.accounts[0];
        const requiredAccountFields = ['id', 'firstName', 'lastName', 'email', 'password', 'role', 'verified'];
        
        for (const field of requiredAccountFields) {
            if (!(field in sampleAccount)) {
                console.error(`Account missing required field: ${field}`);
                return false;
            }
        }
    }
    
    return true;
}

// Seed default data with enhanced structure
function seedDefaultData() {
    const now = new Date().toISOString();
    
    window.db = {
        accounts: [
            {
                id: 1,
                firstName: 'Admin',
                lastName: 'User',
                email: 'admin@example.com',
                password: 'Password123!',
                role: 'admin',
                verified: true,
                createdAt: now,
                lastLogin: null
            },
            {
                id: 2,
                firstName: 'John',
                lastName: 'Doe',
                email: 'user@example.com',
                password: 'user123',
                role: 'user',
                verified: true,
                createdAt: now,
                lastLogin: null
            },
            {
                id: 3,
                firstName: 'Jane',
                lastName: 'Smith',
                email: 'jane@example.com',
                password: 'jane123',
                role: 'user',
                verified: false,
                createdAt: now,
                lastLogin: null
            }
        ],
        departments: [
            {
                id: 1,
                name: 'Engineering',
                description: 'Software development and engineering',
                createdAt: now,
                updatedAt: now
            },
            {
                id: 2,
                name: 'Human Resources',
                description: 'HR and personnel management',
                createdAt: now,
                updatedAt: now
            },
            {
                id: 3,
                name: 'Marketing',
                description: 'Marketing and communications',
                createdAt: now,
                updatedAt: now
            },
            {
                id: 4,
                name: 'Sales',
                description: 'Sales and business development',
                createdAt: now,
                updatedAt: now
            }
        ],
        employees: [
            {
                id: 1,
                employeeId: 'EMP001',
                userId: 2, // References John Doe
                position: 'Software Developer',
                departmentId: 1, // Engineering
                hireDate: '2024-01-15',
                status: 'active',
                createdAt: now,
                updatedAt: now
            }
        ],
        requests: [
            {
                id: 1,
                type: 'Leave',
                items: [
                    { name: 'Annual Leave', quantity: 5 }
                ],
                status: 'Pending',
                employeeEmail: 'user@example.com',
                createdAt: now,
                updatedAt: now
            }
        ]
    };
    
    saveToStorage();
    console.log('âœ… Default data seeded successfully');
    showNotification('Default database seeded', 'success');
}

// Save to localStorage with error handling
function saveToStorage() {
    try {
        // Add metadata to the saved data
        const dataToSave = {
            ...window.db,
            _metadata: {
                lastSaved: new Date().toISOString(),
                version: '1.0',
                recordCounts: {
                    accounts: window.db.accounts.length,
                    departments: window.db.departments.length,
                    employees: window.db.employees.length,
                    requests: window.db.requests.length
                }
            }
        };
        
        const serializedData = JSON.stringify(dataToSave);
        
        // Check storage quota (approximate)
        const dataSize = new Blob([serializedData]).size;
        const maxSize = 5 * 1024 * 1024; // 5MB limit for localStorage
        
        if (dataSize > maxSize) {
            throw new Error('Data size exceeds localStorage limit');
        }
        
        localStorage.setItem(STORAGE_KEY, serializedData);
        console.log('âœ… Data saved to storage. Size:', formatBytes(dataSize));
        
        // Update storage status display
        updateStorageStatus(dataSize);
        
    } catch (e) {
        console.error('âŒ Failed to save to storage:', e);
        showNotification('Failed to save data: ' + e.message, 'danger');
    }
}

// Format bytes to human readable format
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Update storage status in UI (optional)
function updateStorageStatus(dataSize) {
    // You could add a small indicator in the UI showing storage status
    console.log(`Storage used: ${formatBytes(dataSize)}`);
}

// Log storage status
function logStorageStatus() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
        const size = new Blob([stored]).size;
        console.log(`ðŸ“Š Storage status: ${formatBytes(size)} used`);
        
        try {
            const data = JSON.parse(stored);
            console.log('ðŸ“Š Record counts:', data._metadata?.recordCounts || {
                accounts: data.accounts.length,
                departments: data.departments.length,
                employees: data.employees.length,
                requests: data.requests.length
            });
        } catch (e) {
            console.error('Could not parse stored data for stats');
        }
    }
}

// Export data to JSON file (backup feature)
function exportData() {
    const dataStr = JSON.stringify(window.db, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `db-backup-${new Date().toISOString().slice(0,10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('Database exported successfully', 'success');
}

// Import data from JSON file (restore feature)
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validate imported data
            if (isValidDbStructure(importedData)) {
                window.db = importedData;
                saveToStorage();
                showNotification('Data imported successfully! Refreshing...', 'success');
                
                // Refresh the page to show new data
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification('Invalid database file format', 'danger');
            }
        } catch (error) {
            showNotification('Error parsing import file', 'danger');
        }
    };
    reader.readAsText(file);
}

// Clear all data (with confirmation)
function clearAllData() {
    if (confirm('âš ï¸ Are you sure you want to clear ALL data? This cannot be undone!')) {
        localStorage.removeItem(STORAGE_KEY);
        seedDefaultData();
        showNotification('All data cleared and reset to defaults', 'warning');
        
        // Refresh the page
        setTimeout(() => {
            location.reload();
        }, 1500);
    }
}

// Navigation function
function navigateTo(path) {
    window.location.hash = '#' + path;
}

// Handle routing logic
function handleRouting() {
    // Get the current hash path (remove the '#' character)
    let hash = window.location.hash.slice(1) || '/';
    
    // Handle empty hash or just '#'
    if (hash === '') {
        hash = '/';
    }
    
    console.log('Navigating to:', hash);
    
    // Get the route path (remove any query parameters)
    const path = hash.split('?')[0];
    
    // Check if route exists, otherwise default to home
    const pageId = routes[path] || 'home-page';
    
    // Check authentication for protected routes
    if (protectedRoutes.includes(path)) {
        if (!isAuthenticated()) {
            console.log('Unauthorized access to protected route, redirecting to login');
            showNotification('Please login to access this page', 'warning');
            navigateTo('/login');
            return;
        }
    }
    
    // Check admin routes
    if (adminRoutes.includes(path)) {
        if (!isAdmin()) {
            console.log('Unauthorized access to admin route, redirecting to home');
            showNotification('Access denied. Admin privileges required.', 'danger');
            navigateTo('/');
            return;
        }
    }
    
    // Special handling for verify email page
    if (path === '/verify-email') {
        const unverifiedEmail = localStorage.getItem('unverified_email');
        if (!unverifiedEmail) {
            showNotification('No pending verification found', 'warning');
            navigateTo('/register');
            return;
        }
    }
    
    // Update active page
    showPage(pageId);
    
    // Update navigation active state
    updateActiveNavLink(path);
    
    // Update page title
    updatePageTitle(pageId);
    
    // Trigger page-specific rendering
    renderPageContent(pageId);
}

// Check if user is authenticated
function isAuthenticated() {
    return currentUser !== null;
}

// Check if user is admin
function isAdmin() {
    return currentUser && currentUser.role === 'admin';
}

// Show a specific page
function showPage(pageId) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Show the target page
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    } else {
        console.error('Page not found:', pageId);
        // Fallback to home page
        const homePage = document.getElementById('home-page');
        if (homePage) {
            homePage.classList.add('active');
        }
    }
}

// Update active navigation link
function updateActiveNavLink(path) {
    // Remove active class from all nav links
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Add active class to current link
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href === '#' + path || href === '#/' + path) {
            link.classList.add('active');
        }
    });
}

// Update page title
function updatePageTitle(pageId) {
    const titles = {
        'home-page': 'Home',
        'register-page': 'Register',
        'verify-email-page': 'Verify Email',
        'login-page': 'Login',
        'profile-page': 'Profile',
        'employees-page': 'Employees',
        'departments-page': 'Departments',
        'accounts-page': 'Accounts',
        'requests-page': 'My Requests'
    };
    
    const pageName = titles[pageId] || 'Full-Stack App';
    document.title = `${pageName} - Full-Stack App (Student Build)`;
}

// Render page-specific content
function renderPageContent(pageId) {
    switch (pageId) {
        case 'profile-page':
            renderProfilePage();
            break;
        case 'employees-page':
            renderEmployeesPage();
            break;
        case 'departments-page':
            renderDepartmentsPage();
            break;
        case 'accounts-page':
            renderAccountsPage();
            break;
        case 'requests-page':
            renderRequestsPage();
            break;
        case 'verify-email-page':
            renderVerifyEmailPage();
            break;
    }
}

// Page-specific render functions
function renderProfilePage() {
    if (currentUser) {
        document.getElementById('profile-name').textContent = 
            `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById('profile-email').textContent = currentUser.email;
        document.getElementById('profile-role').textContent = 
            currentUser.role === 'admin' ? 'Administrator' : 'User';
        
        // Add account creation date if available
        if (currentUser.createdAt) {
            const createdDate = new Date(currentUser.createdAt).toLocaleDateString();
            const profileCard = document.querySelector('#profile-page .card-body');
            if (!document.getElementById('profile-created')) {
                const p = document.createElement('p');
                p.id = 'profile-created';
                p.innerHTML = `<strong>Member since:</strong> ${createdDate}`;
                profileCard.insertBefore(p, document.getElementById('edit-profile-btn'));
            }
        }
    }
}

function renderEmployeesPage() {
    const tbody = document.getElementById('employees-table-body');
    if (window.db.employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No employees found</td></tr>';
    } else {
        let html = '';
        window.db.employees.forEach(emp => {
            const user = window.db.accounts.find(a => a.id === emp.userId);
            const dept = window.db.departments.find(d => d.id === emp.departmentId);
            html += `
                <tr>
                    <td>${emp.employeeId}</td>
                    <td>${user ? user.email : 'Unknown'}</td>
                    <td>${emp.position}</td>
                    <td>${dept ? dept.name : 'Unknown'}</td>
                    <td>
                        <span class="badge bg-${emp.status === 'active' ? 'success' : 'secondary'}">${emp.status}</span>
                        <button class="btn btn-sm btn-warning" onclick="alert('Edit employee coming in Phase 6')">Edit</button>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }
}

function renderDepartmentsPage() {
    const tbody = document.getElementById('departments-table-body');
    if (window.db.departments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">No departments found</td></tr>';
    } else {
        let html = '';
        window.db.departments.forEach(dept => {
            html += `
                <tr>
                    <td>${dept.name}</td>
                    <td>${dept.description}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editDepartment(${dept.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDepartment(${dept.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }
}

function renderAccountsPage() {
    const tbody = document.getElementById('accounts-table-body');
    if (window.db.accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No accounts found</td></tr>';
    } else {
        let html = '';
        window.db.accounts.forEach(account => {
            html += `
                <tr>
                    <td>${account.firstName} ${account.lastName}</td>
                    <td>${account.email}</td>
                    <td><span class="badge bg-${account.role === 'admin' ? 'danger' : 'info'}">${account.role}</span></td>
                    <td><span class="badge bg-${account.verified ? 'success' : 'warning'}">${account.verified ? 'Verified' : 'Pending'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editAccount(${account.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAccount(${account.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }
}

function renderRequestsPage() {
    const tbody = document.getElementById('requests-table-body');
    if (window.db.requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No requests found</td></tr>';
    } else {
        let html = '';
        // Filter requests for current user if not admin
        const requestsToShow = currentUser?.role === 'admin' 
            ? window.db.requests 
            : window.db.requests.filter(r => r.employeeEmail === currentUser?.email);
        
        requestsToShow.forEach(req => {
            const itemsList = req.items.map(i => `${i.name} (${i.quantity})`).join(', ');
            const statusClass = {
                'Pending': 'warning',
                'Approved': 'success',
                'Rejected': 'danger'
            }[req.status] || 'secondary';
            
            html += `
                <tr>
                    <td>${req.type}</td>
                    <td>${itemsList}</td>
                    <td><span class="badge bg-${statusClass}">${req.status}</span></td>
                    <td>${new Date(req.createdAt).toLocaleDateString()}</td>
                </tr>
            `;
        });
        tbody.innerHTML = html || '<tr><td colspan="4" class="text-center">No requests found</td></tr>';
    }
}

function renderVerifyEmailPage() {
    const unverifiedEmail = localStorage.getItem('unverified_email');
    if (unverifiedEmail) {
        document.getElementById('unverified-email').textContent = unverifiedEmail;
        document.getElementById('verify-email-message').className = 'alert alert-info';
        document.getElementById('verify-email-message').innerHTML = 
            `Verification sent to <strong>${unverifiedEmail}</strong>`;
    } else {
        document.getElementById('verify-email-message').className = 'alert alert-warning';
        document.getElementById('verify-email-message').innerHTML = 
            'No pending verification found. Please <a href="#/register">register</a> first.';
    }
}

// Setup navigation links to use client-side routing
function setupNavigationLinks() {
    document.addEventListener('click', function(e) {
        // Check if clicked element is a navigation link
        const link = e.target.closest('a');
        if (!link) return;
        
        const href = link.getAttribute('href');
        
        // Handle internal navigation links (starting with #/)
        if (href && href.startsWith('#/')) {
            e.preventDefault();
            navigateTo(href.slice(1)); // Remove the '#' and navigate
        }
        
        // Handle logout link
        if (link.id === 'logout-btn') {
            e.preventDefault();
            handleLogout();
        }
    });
}

// Show notification with optional duration
function showNotification(message, type = 'info', duration = 3000) {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type} border-0`;
    toast.id = toastId;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove after duration
    setTimeout(() => {
        toast.remove();
    }, duration);
}

// Setup form listeners
function setupFormListeners() {
    // Register form
    const registerForm = document.getElementById('register-form');
    if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleRegister();
        });
    }
    
    // Login form
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });
    }
    
    // Simulate verify button
    const verifyBtn = document.getElementById('simulate-verify-btn');
    if (verifyBtn) {
        verifyBtn.addEventListener('click', function() {
            simulateVerification();
        });
    }
    
    // Edit profile button
    const editProfileBtn = document.getElementById('edit-profile-btn');
    if (editProfileBtn) {
        editProfileBtn.addEventListener('click', function() {
            showNotification('Edit profile functionality coming in Phase 5!', 'info');
        });
    }
    
    // Admin action buttons
    const addEmployeeBtn = document.getElementById('add-employee-btn');
    if (addEmployeeBtn) {
        addEmployeeBtn.addEventListener('click', function() {
            showNotification('Add employee functionality coming in Phase 6!', 'info');
        });
    }
    
    const addDepartmentBtn = document.getElementById('add-department-btn');
    if (addDepartmentBtn) {
        addDepartmentBtn.addEventListener('click', function() {
            showNotification('Add department functionality coming in Phase 6!', 'info');
        });
    }
    
    const addAccountBtn = document.getElementById('add-account-btn');
    if (addAccountBtn) {
        addAccountBtn.addEventListener('click', function() {
            showNotification('Add account functionality coming in Phase 6!', 'info');
        });
    }
    
    const newRequestBtn = document.getElementById('new-request-btn');
    if (newRequestBtn) {
        newRequestBtn.addEventListener('click', function() {
            showNotification('New request functionality coming in Phase 7!', 'info');
        });
    }
}

// Handle registration
function handleRegister() {
    const firstName = document.getElementById('first-name').value.trim();
    const lastName = document.getElementById('last-name').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    
    // Validate inputs
    if (!firstName || !lastName || !email || !password) {
        showNotification('Please fill in all fields', 'warning');
        return;
    }
    
    if (password.length < 6) {
        showNotification('Password must be at least 6 characters', 'warning');
        return;
    }
    
    if (!isValidEmail(email)) {
        showNotification('Please enter a valid email address', 'warning');
        return;
    }
    
    // Check if email already exists
    const existingUser = window.db.accounts.find(acc => acc.email.toLowerCase() === email.toLowerCase());
    
    if (existingUser) {
        showNotification('Email already registered!', 'danger');
        return;
    }
    
    // Create new account (always as user for security)
    const newAccount = {
        id: generateId(),
        firstName,
        lastName,
        email: email.toLowerCase(),
        password: password, // In real app, this would be hashed!
        role: 'user', // Always create as regular user
        verified: false,
        createdAt: new Date().toISOString(),
        lastLogin: null
    };
    
    window.db.accounts.push(newAccount);
    saveToStorage(); // Save after adding
    
    // Store email for verification
    localStorage.setItem('unverified_email', email.toLowerCase());
    
    // Clear form
    document.getElementById('register-form').reset();
    
    showNotification('Registration successful! Please verify your email.', 'success');
    
    // Navigate to verify email page
    navigateTo('/verify-email');
    
    console.log('Registration successful:', email);
}

// Validate email format
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Generate simple ID
function generateId() {
    return Date.now() + Math.floor(Math.random() * 1000);
}

// Simulate email verification
function simulateVerification() {
    const unverifiedEmail = localStorage.getItem('unverified_email');
    
    if (!unverifiedEmail) {
        showNotification('No unverified email found!', 'warning');
        return;
    }
    
    const account = window.db.accounts.find(acc => acc.email === unverifiedEmail);
    
    if (account) {
        if (account.verified) {
            showNotification('This account is already verified!', 'info');
            localStorage.removeItem('unverified_email');
            navigateTo('/login');
            return;
        }
        
        account.verified = true;
        saveToStorage(); // Save after updating
        localStorage.removeItem('unverified_email');
        
        showNotification('Email verified successfully! You can now login.', 'success');
        navigateTo('/login');
    } else {
        showNotification('Account not found!', 'danger');
        localStorage.removeItem('unverified_email');
    }
}

// Handle login
function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        showNotification('Please fill in all fields', 'warning');
        return;
    }
    
    // Find account with matching email, password, and verified status
    const account = window.db.accounts.find(acc => 
        acc.email.toLowerCase() === email.toLowerCase() && 
        acc.password === password
    );
    
    if (!account) {
        showNotification('Invalid email or password!', 'danger');
        return;
    }
    
    if (!account.verified) {
        showNotification('Please verify your email before logging in.', 'warning');
        // Store email for verification if not already there
        localStorage.setItem('unverified_email', account.email);
        navigateTo('/verify-email');
        return;
    }
    
    // Update last login
    account.lastLogin = new Date().toISOString();
    saveToStorage(); // Save after updating
    
    // Set auth state
    setAuthState(true, account);
    
    // Save to localStorage
    localStorage.setItem('auth_token', account.email);
    
    // Clear login form
    document.getElementById('login-form').reset();
    
    showNotification(`Welcome back, ${account.firstName}!`, 'success');
    
    // Navigate to profile
    navigateTo('/profile');
    
    console.log('Login successful:', email);
}

// Handle logout
function handleLogout() {
    // Clear auth state
    setAuthState(false, null);
    
    // Remove from localStorage
    localStorage.removeItem('auth_token');
    
    showNotification('Logged out successfully', 'info');
    
    // Navigate to home
    navigateTo('/');
    
    console.log('Logout successful');
}

// Set authentication state
function setAuthState(isAuth, user) {
    currentUser = user;
    
    const body = document.body;
    
    if (isAuth && user) {
        body.classList.remove('not-authenticated');
        body.classList.add('authenticated');
        
        // Update username display
        const usernameDisplay = document.getElementById('username-display');
        if (usernameDisplay) {
            usernameDisplay.textContent = `${user.firstName} ${user.lastName}`;
        }
        
        // Check if admin
        if (user.role === 'admin') {
            body.classList.add('is-admin');
        } else {
            body.classList.remove('is-admin');
        }
        
        // Update profile page if it's visible
        if (document.getElementById('profile-page').classList.contains('active')) {
            renderProfilePage();
        }
    } else {
        body.classList.add('not-authenticated');
        body.classList.remove('authenticated', 'is-admin');
        
        // Clear username display
        const usernameDisplay = document.getElementById('username-display');
        if (usernameDisplay) {
            usernameDisplay.textContent = 'User';
        }
    }
}

// Check for existing session on load
function checkExistingSession() {
    const token = localStorage.getItem('auth_token');
    
    if (token) {
        const account = window.db.accounts.find(acc => acc.email === token);
        if (account && account.verified) {
            setAuthState(true, account);
            console.log('Session restored for:', account.email);
        } else {
            // Clear invalid token
            localStorage.removeItem('auth_token');
        }
    }
}

// Admin CRUD operations (to be used in Phase 6)
function editDepartment(id) {
    showNotification('Edit department coming in Phase 6', 'info');
}

function deleteDepartment(id) {
    if (confirm('Are you sure you want to delete this department?')) {
        window.db.departments = window.db.departments.filter(d => d.id !== id);
        saveToStorage();
        renderDepartmentsPage();
        showNotification('Department deleted', 'success');
    }
}

function editAccount(id) {
    showNotification('Edit account coming in Phase 6', 'info');
}

function deleteAccount(id) {
    if (id === currentUser?.id) {
        showNotification('You cannot delete your own account!', 'danger');
        return;
    }
    
    if (confirm('Are you sure you want to delete this account?')) {
        window.db.accounts = window.db.accounts.filter(a => a.id !== id);
        saveToStorage();
        renderAccountsPage();
        showNotification('Account deleted', 'success');
    }
}

// Test function to demonstrate persistence
function testPersistence() {
    console.log('ðŸ§ª Testing Data Persistence:');
    console.log('1. Register a new account â†’ Data saved to localStorage');
    console.log('2. Refresh the page â†’ Data should persist');
    console.log('3. Login â†’ lastLogin timestamp updates');
    console.log('4. Check browser DevTools â†’ Application â†’ Local Storage');
    console.log('5. Try export/import features (if implemented)');
    
    // Show current storage info
    logStorageStatus();
}

// Make utility functions available globally
window.testPersistence = testPersistence;
window.exportData = exportData;
window.clearAllData = clearAllData;
window.logStorageStatus = logStorageStatus;
